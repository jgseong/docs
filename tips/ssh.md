# SSH connection by public key authentication

## Generate key pair by `ssh-keygen` at the client machine
```bash
# refer to `man ssh-keygen`, `ssh-keygen --help`
ssh-keygen -t ed25519 -b 512 -f ~/.ssh/jgseong7@naver.com -C "jgseong7@naver.com"
# -t : public key cipher type
# -b : key length in bit
# -f : output file
# -C : comment for key
#@note: to encrypt key file, input a passphrase. if empty passphrase, then the private key file would be written as cleartext.
#@note: the file names and private key comments can be arbitrary.
```
## Check key pair
```bash
$ ls ~/.ssh/
authorized_keys    jgseong7@naver.com    jgseong7@naver.com.pub

# authorized_keys : a file for public key authentication (may be not existed)
# jgseong7@naver.com : private key generated by previous step.
# jgseong7@naver.com.pub : public key generated by previous step. typically, the file name is followed by the suffix '.pub'.
```
## Copy the public key to server
* do follows at client side.
```bash
# copy a file contents in 'jgseong7@naver.com.pub' and write it to 'authorized_keys' file by ssh and tee
cat ~/.ssh/jgseong7@naver.com.pub | ssh -t ubuntu@172.16.99.17 'tee -a ~/.ssh/authorized_keys'

# in alternative way, copy the public key file and write it to 'authorized_keys' file by scp and ssh
scp ~/.ssh/jgseong7@naver.com.pub ubuntu@172.16.99.17:
ssh -t ubuntu@172.16.99.17 'cat jgseong7@naver.com.pub >> ~/.ssh/authorized_keys'
ssh -t ubuntu@172.16.99.17 'rm jgseong7@naver.com.pub'
```
## Check `sshd_config` and restart `sshd`
```bash
# '/etc/ssh/sshd_config' in default on ubuntu 16.04 LTS
cat /etc/ssh/sshd_config | grep -E 'PubkeyAuthentication|RSAAuthentication'
# check PubkeyAuthentication yes
# check RSAAuthentication yes  # for RSA public key

cat /etc/ssh/sshd_config | grep -E 'AuthorizedKeysFile'
# check 'AuthorizedKeysFile	%h/.ssh/authorized_keys' or '#AuthorizedKeysFile	%h/.ssh/authorized_keys'
# default authorizedKyesFile path is '%h/.ssh/authorized_keys'

# Restart ssh daemons
sudo systemctl restart sshd
```
## Connect SSH by pubkey
```bash
# -i : specify a identity file. (a.k.a. private key)
ssh -i ~/.ssh/jgseong7@naver.com ubuntu@172.16.99.17

# identity file could be specifable in `ssh_config`
# check 'IdentityFile'
cat /etc/ssh/ssh_config | grep IdentityFile
# if no 'IdentityFile' graped, insert configuration.
echo 'IdentityFile ~/.ssh/jgseong7@naver.com' >> /etc/ssh/ssh_config
# to append another identity file.
echo 'IdentityFile ~/.ssh/id_admin_ubuntu1_vultr' >> /etc/ssh/ssh_config
echo 'IdentityFile ~/.ssh/id_jgseong_ubuntu2_vultr' >> /etc/ssh/ssh_config
```
* Check identity file in 'ssh_config'
```
$ cat /etc/ssh/ssh_config | grep IdentityFile
IdentityFile ~/.ssh/jgseong7@naver.com
IdentityFile ~/.ssh/id_admin_ubuntu1_vultr
IdentityFile ~/.ssh/id_jgseong_ubuntu2_vultr
```
